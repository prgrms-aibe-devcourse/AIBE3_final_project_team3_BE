name: CI - Integration Tests

on:
  pull_request:
    branches: [ dev, prod ]
  push:
    branches: [ dev, prod ]

jobs:
  wait-for-build:
    name: Wait for Docker Build
    runs-on: ubuntu-latest
    steps:
      - name: Wait for build workflow
        uses: lewagon/wait-on-check-action@v1.3.1
        with:
          ref: ${{ github.ref }}
          check-name: 'Build and Push Docker Image'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 10

  test:
    name: Run Integration Tests
    runs-on: ubuntu-latest
    needs: wait-for-build
    env:
      TZ: Asia/Seoul

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD || 'rootpw' }}
          MYSQL_DATABASE: ${{ secrets.MYSQL_TEST_DATABASE || 'mysql_test' }}
          MYSQL_USER: ${{ secrets.MYSQL_TEST_USER || 'testuser' }}
          MYSQL_PASSWORD: ${{ secrets.MYSQL_TEST_PASSWORD || 'testpass' }}
          TZ: Asia/Seoul
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h127.0.0.1 -uroot -p$$MYSQL_ROOT_PASSWORD"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

      redis:
        image: redis:8.0-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
        env:
          REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD || 'redispass' }}

      mongo:
        image: mongo:6.0
        env:
          MONGO_INITDB_ROOT_USERNAME: ${{ secrets.MONGO_INITDB_ROOT_USERNAME || 'mongoadmin' }}
          MONGO_INITDB_ROOT_PASSWORD: ${{ secrets.MONGO_INITDB_ROOT_PASSWORD || 'mongopass' }}
          MONGO_INITDB_DATABASE: ${{ secrets.MONGO_TEST_DB || 'mongo_test' }}
          TZ: Asia/Seoul
        ports:
          - 27017:27017
        options: >-
          --health-cmd="mongosh --quiet --eval 'db.runCommand({ping:1}).ok'"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: gradle

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Wait for services to be ready
        run: |
          echo "Waiting for MySQL..."
          timeout 60 bash -c 'until mysqladmin ping -h127.0.0.1 -P3306 -uroot -p${{ secrets.MYSQL_ROOT_PASSWORD || 'rootpw' }} --silent; do sleep 2; done'
          echo "Waiting for Redis..."
          timeout 60 bash -c 'until redis-cli -h 127.0.0.1 -p 6379 ping; do sleep 2; done'
          echo "Waiting for MongoDB..."
          timeout 60 bash -c 'until mongosh --host 127.0.0.1:27017 --eval "db.adminCommand({ping:1})" --quiet; do sleep 2; done'

      - name: Run integration tests
        env:
          SPRING_PROFILES_ACTIVE: test
          MYSQL_HOST: 127.0.0.1
          MYSQL_PORT: 3306
          MYSQL_DATABASE: ${{ secrets.MYSQL_TEST_DATABASE || 'mysql_test' }}
          MYSQL_USER: ${{ secrets.MYSQL_TEST_USER || 'testuser' }}
          MYSQL_PASSWORD: ${{ secrets.MYSQL_TEST_PASSWORD || 'testpass' }}
          REDIS_HOST: 127.0.0.1
          REDIS_PORT: 6379
          REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD || 'redispass' }}
          MONGO_HOST: 127.0.0.1
          MONGO_PORT: 27017
          MONGO_USERNAME: ${{ secrets.MONGO_INITDB_ROOT_USERNAME || 'mongoadmin' }}
          MONGO_PASSWORD: ${{ secrets.MONGO_INITDB_ROOT_PASSWORD || 'mongopass' }}
          MONGO_DATABASE: ${{ secrets.MONGO_TEST_DB || 'mongo_test' }}
        run: ./gradlew clean test --no-daemon --stacktrace
